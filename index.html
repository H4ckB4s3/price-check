<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HNS Historical Price Calculator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="script.js" defer></script>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --secondary: #8b949e;
      --accent: #58a6ff;
      --btn: #238636;
      --btn-hover: #2ea043;
      --danger: #f85149;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 20px;
    }

    h1 {
      font-size: 26px;
      margin-bottom: 8px;
    }

    .description {
      color: var(--secondary);
    }

    .current-price {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      color: var(--secondary);
    }

    .current-price .price-value {
      font-weight: 600;
      color: var(--text);
    }

    .container {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 25px;
      margin: auto;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    label {
      font-weight: 500;
      color: var(--secondary);
      margin-bottom: 6px;
      display: block;
    }

    input, button, select {
      width: 100%;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 15px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(88,166,255,.3);
    }
    
    .hns-input {
      margin-top: 15px;
    }

    button {
      background: var(--btn);
      color: #fff;
      border: none;
      font-weight: 600;
      margin-top: 15px;
      cursor: pointer;
      transition: background .2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover { background: var(--btn-hover); }
    button:disabled { background: #555; cursor: not-allowed; }

    /* Datepicker */
    .date-selector { position: relative; }
    .date-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      cursor: pointer;
    }

    .calendar-popup {
      display: none;
      position: absolute;
      top: 110%;
      left: 0;
      width: 100%;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,.5);
      padding: 15px;
      z-index: 10;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .calendar-header button {
      width: auto;
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
    }

    .calendar-header button:hover {
      background: var(--bg);
    }

    .calendar-header select {
      margin-left: 6px;
    }

    .weekday-grid, .days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .weekday-header {
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--secondary);
    }

    .calendar-cell {
      text-align: center;
      padding: 21px 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background .15s;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 34px;
    }

    .calendar-cell:hover { background: rgba(88,166,255,0.2); }
    .calendar-cell.selected { background: var(--accent); color: #fff; font-weight: 600; }
    .calendar-cell.disabled { color: var(--border); cursor: not-allowed; }
    .calendar-cell.disabled:hover { background: none; }
    .calendar-cell.empty { cursor: default; }

    .result {
      margin-top: 20px;
      padding: 18px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      text-align: center;
    }

    .price {
      font-size: 28px;
      font-weight: 700;
      margin: 8px 0;
    }

    .date-info {
      font-size: 14px;
      color: var(--secondary);
    }

    .error {
      display: none;
      background: rgba(248,81,73,.1);
      border: 1px solid rgba(248,81,73,.4);
      color: var(--danger);
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      font-size: 14px;
    }

    footer {
      margin-top: auto;
      padding: 25px 0;
      text-align: center;
      font-size: 14px;
      color: var(--secondary);
    }

    footer a { color: var(--accent); text-decoration: none; }
    footer a:hover { text-decoration: underline; }

    @media(max-width:600px){
      .calendar-popup {
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%,-50%);
        width: 95%;
        max-width: 360px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>HNS Historical Price Calculator</h1>
    <p class="description">Calculate the USD value of HNS since February 13, 2020</p>
    <div class="current-price">
      <i class="fas fa-coins"></i>
      Current Price: <span id="current-price-value">Loading...</span>
    </div>
  </header>

  <div class="container">
    <!-- Date -->
    <div class="input-group">
      <label for="date">Date</label>
      <div class="date-selector">
        <div class="date-display" id="date-display">
          <span id="selected-date">Select a date</span>
          <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="calendar-popup" id="calendar-popup">
          <div class="calendar-header">
            <button id="prev-month"><i class="fas fa-chevron-left"></i></button>
            <div>
              <span id="calendar-month"></span>
              <select id="calendar-year"></select>
            </div>
            <button id="next-month"><i class="fas fa-chevron-right"></i></button>
          </div>
          <div class="weekday-grid">
            <div class="weekday-header">Sun</div>
            <div class="weekday-header">Mon</div>
            <div class="weekday-header">Tue</div>
            <div class="weekday-header">Wed</div>
            <div class="weekday-header">Thu</div>
            <div class="weekday-header">Fri</div>
            <div class="weekday-header">Sat</div>
          </div>
          <div class="days-grid" id="calendar-days"></div>
        </div>
      </div>
    </div>

    <!-- Amount -->
    <div class="input-group">
      <div class="hns-input">
        <span class="hns-prefix">HNS</span>
        <input type="number" id="amount" placeholder="Enter amount" min="0" max="888000000" step="any">
      </div>
    </div>

    <button id="calculate-btn"><i class="fas fa-calculator"></i> Check Historical Price in USD</button>

    <div class="loading" id="loading" style="display:none;">
      <i class="fas fa-spinner fa-spin"></i> Fetching data...
    </div>

    <div class="error" id="error"></div>

    <div class="result" id="result" style="display:none;">
      <h3>Historical Value</h3>
      <div class="price" id="price">$0.00</div>
      <div class="price" id="price-btc">0.00000000 BTC</div>
      <div class="date-info" id="date-info"></div>
    </div>
  </div>

  <footer>
    &copy; <span id="current-year"></span> - <a href="https://github.com/h4ckb4s3" target="_blank">Github</a>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('current-year').textContent = new Date().getFullYear();

      let currentDate = new Date();
      let selectedDate = null;
      const minDate = new Date('2020-02-13');
      const maxDate = new Date(); // today
      const yearSelect = document.getElementById('calendar-year');
      const monthLabel = document.getElementById('calendar-month');

      // Fill year dropdown
      for (let y = minDate.getFullYear(); y <= maxDate.getFullYear(); y++) {
        let opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        yearSelect.appendChild(opt);
      }

      // Format date to YYYY-MM-DD (UTC)
      function formatDate(date){
        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const day = String(date.getUTCDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function updateCalendar(){
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        monthLabel.textContent = currentDate.toLocaleString('default',{month:'long'});
        yearSelect.value = year;

        const calendarDays = document.getElementById('calendar-days');
        calendarDays.innerHTML = '';

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month+1,0).getDate();

        for(let i=0;i<firstDay;i++){
          const e=document.createElement('div');
          e.className="calendar-cell empty";
          calendarDays.appendChild(e);
        }

        for(let d=1; d<=daysInMonth; d++){
          const cellDate = new Date(Date.UTC(year, month, d));
          const cell = document.createElement('div');
          cell.className="calendar-cell";
          cell.textContent=d;

          if(cellDate < minDate || cellDate > maxDate){
            cell.classList.add('disabled');
          } else {
            if(selectedDate && formatDate(cellDate) === formatDate(selectedDate)){
              cell.classList.add('selected');
            }
            cell.addEventListener('click',()=>{
              selectedDate = cellDate;
              document.getElementById('selected-date').textContent = formatDate(selectedDate);
              document.getElementById('calendar-popup').style.display='none';
              updateCalendar();
            });
          }
          calendarDays.appendChild(cell);
        }
      }

      updateCalendar();

      document.getElementById('date-display').addEventListener('click',()=>{
        const popup=document.getElementById('calendar-popup');
        popup.style.display=popup.style.display==='block'?'none':'block';
      });

      document.getElementById('prev-month').addEventListener('click',()=>{
        currentDate.setMonth(currentDate.getMonth()-1);
        if(currentDate<minDate) currentDate=new Date(minDate);
        updateCalendar();
      });

      document.getElementById('next-month').addEventListener('click',()=>{
        currentDate.setMonth(currentDate.getMonth()+1);
        if(currentDate>maxDate) currentDate=new Date(maxDate);
        updateCalendar();
      });

      yearSelect.addEventListener('change',()=>{
        currentDate.setFullYear(parseInt(yearSelect.value,10));
        if(currentDate<minDate) currentDate=new Date(minDate);
        if(currentDate>maxDate) currentDate=new Date(maxDate);
        updateCalendar();
      });

      document.addEventListener('click',e=>{
        const cal=document.getElementById('calendar-popup');
        const disp=document.getElementById('date-display');
        if(!cal.contains(e.target)&&!disp.contains(e.target)){
          cal.style.display='none';
        }
      });

      async function fetchCurrentPrice() {
        try {
          const response = await fetch('https://price.hns.dev/latest');
          if (!response.ok) throw new Error('Failed to fetch current price');
          
          // The API returns a simple number, not a JSON object
          const price = await response.text();
          document.getElementById('current-price-value').textContent = `$${parseFloat(price).toFixed(6)}`;
        } catch(error) {
          console.error('Error fetching current price:', error);
          document.getElementById('current-price-value').textContent = 'Unavailable';
          
          // Fallback: Try with CORS proxy if direct request fails
          try {
            const proxyResponse = await fetch('https://corsproxy.io/?' + encodeURIComponent('https://price.hns.dev/latest'));
            if (proxyResponse.ok) {
              const proxyPrice = await proxyResponse.text();
              document.getElementById('current-price-value').textContent = `$${parseFloat(proxyPrice).toFixed(6)}`;
            }
          } catch(proxyError) {
            console.error('CORS proxy also failed:', proxyError);
          }
        }
      }

      fetchCurrentPrice();

      document.getElementById('calculate-btn').addEventListener('click',()=>{
        if(!selectedDate) return showError('Please select a date');
        const amt=parseFloat(document.getElementById('amount').value);
        if(!amt||amt<=0) return showError('Please enter a valid HNS amount');
        if(amt>888000000) return showError('Maximum HNS is 888,000,000');
        document.getElementById('error').style.display='none';
        document.getElementById('result').style.display='none';
        document.getElementById('loading').style.display='block';
        fetchHistoricalData(formatDate(selectedDate),amt);
      });
    });

    function showError(msg){
      const e=document.getElementById('error');
      e.textContent=msg; e.style.display='block';
    }

    // High precision calculation function
    function calculatePreciseAverage(data) {
      // Convert prices to integers (multiply by 1e12 for BTC to preserve precision)
      const multiplier = 1e12;
      const sum = data.reduce((total, item) => {
        return total + Math.round(item.price * multiplier);
      }, 0);
      
      // Calculate average and convert back to decimal
      return sum / data.length / multiplier;
    }

    // Function to format very small numbers without scientific notation
    function formatSmallNumber(num, precision = 12) {
      if (num >= 0.001) {
        return num.toFixed(precision);
      }
      
      // For very small numbers, convert to string and pad with zeros
      const numStr = num.toFixed(precision);
      if (numStr.includes('e')) {
        // Handle scientific notation
        const [coefficient, exponent] = numStr.split('e');
        const exp = parseInt(exponent);
        const decimalPlaces = Math.abs(exp) - 1;
        return '0.' + '0'.repeat(decimalPlaces) + coefficient.replace('.', '').replace('-', '');
      }
      return numStr;
    }

    async function fetchHistoricalData(date, amt){
      try {
        // Fetch USD and BTC prices in parallel
        const [usdResp, btcResp] = await Promise.all([
          fetch(`https://corsproxy.io/?${encodeURIComponent(`https://price.hns.dev/historical?from=${date}&currency=usd`)}`),
          fetch(`https://corsproxy.io/?${encodeURIComponent(`https://price.hns.dev/historical?from=${date}&currency=btc`)}`)
        ]);

        if(!usdResp.ok || !btcResp.ok) throw new Error();

        const usdData = await usdResp.json();
        const btcData = await btcResp.json();

        if(!usdData.length || !btcData.length) throw new Error("No data");

        // Use high precision calculation
        const avgUsd = calculatePreciseAverage(usdData);
        const avgBtc = calculatePreciseAverage(btcData);

        // Calculate values with high precision
        const valUsd = Math.round(avgUsd * amt * 1e6) / 1e6;
        
        // Special handling for BTC to avoid floating point issues with very small numbers
        const valBtc = avgBtc * amt;
        
        // Format BTC value with proper precision (decimal notation, not scientific)
        const btcFormatted = formatSmallNumber(valBtc, 12);

        // Update DOM
        document.getElementById('price').textContent = 
          `$${valUsd.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:6})}`;
        document.getElementById('price-btc').textContent = 
          `${btcFormatted} BTC`;

        document.getElementById('date-info').textContent = 
          `Based on avg price $${avgUsd.toFixed(6)} / ${formatSmallNumber(avgBtc, 12)} BTC per HNS on ${date}`;

        document.getElementById('loading').style.display='none';
        document.getElementById('result').style.display='block';
        
        // Log for debugging
        console.log('Precise average calculation:', {
          date: date,
          usdDataPoints: usdData.length,
          btcDataPoints: btcData.length,
          avgUsd: avgUsd,
          avgBtc: avgBtc,
          calculatedValueUSD: valUsd,
          calculatedValueBTC: valBtc,
          formattedBTC: btcFormatted
        });
      } catch(err) {
        console.error(err);
        document.getElementById('loading').style.display='none';
        showError('Error fetching data, try another date.');
      }
    }
  </script>
</body>
</html>
