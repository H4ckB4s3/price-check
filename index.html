<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HNS Historical Price Calculator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="js/warning.js" defer></script>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <h1>HNS Historical Price Calculator</h1>
    <p class="description">Calculate the USD value of HNS since February 13, 2020</p>
    <div class="current-price">
      <i class="fas fa-coins"></i>
      Current Price: <span id="current-price-value">Loading...</span>
    </div>
  </header>

  <div class="container">
    <!-- Date -->
    <div class="input-group">
      <label for="date">Date</label>
      <div class="date-selector">
        <div class="date-display" id="date-display">
          <span id="selected-date">Select a date</span>
          <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="calendar-popup" id="calendar-popup">
          <div class="calendar-header">
            <button id="prev-month"><i class="fas fa-chevron-left"></i></button>
            <div>
              <span id="calendar-month"></span>
              <select id="calendar-year"></select>
            </div>
            <button id="next-month"><i class="fas fa-chevron-right"></i></button>
          </div>
          <div class="weekday-grid">
            <div class="weekday-header">Sun</div>
            <div class="weekday-header">Mon</div>
            <div class="weekday-header">Tue</div>
            <div class="weekday-header">Wed</div>
            <div class="weekday-header">Thu</div>
            <div class="weekday-header">Fri</div>
            <div class="weekday-header">Sat</div>
          </div>
          <div class="days-grid" id="calendar-days"></div>
        </div>
      </div>
    </div>

    <!-- Amount -->
    <div class="input-group">
      <div class="hns-input">
        <span class="hns-prefix">HNS</span>
        <input type="number" id="amount" placeholder="Enter amount" min="0" max="888000000" step="any">
      </div>
    </div>

    <button id="calculate-btn"><i class="fas fa-calculator"></i> Check Historical Price in USD</button>

    <div class="loading" id="loading" style="display:none;">
      <i class="fas fa-spinner fa-spin"></i> Fetching data...
    </div>

    <div class="error" id="error"></div>

    <div class="result" id="result" style="display:none;">
      <h3>Historical Value</h3>
      <div class="price" id="price">$0.00</div>
      <div class="price" id="price-btc">0.00000000 BTC</div>
      <div class="date-info" id="date-info"></div>
    </div>
  </div>

  <footer>
    &copy; <span id="current-year"></span> - <a href="https://github.com/h4ckb4s3" target="_blank">Github</a>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('current-year').textContent = new Date().getFullYear();

      let currentDate = new Date();
      let selectedDate = null;
      const minDate = new Date('2020-02-13');
      const maxDate = new Date(); // today
      const yearSelect = document.getElementById('calendar-year');
      const monthLabel = document.getElementById('calendar-month');

      // Fill year dropdown
      for (let y = minDate.getFullYear(); y <= maxDate.getFullYear(); y++) {
        let opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        yearSelect.appendChild(opt);
      }

      // Format date to YYYY-MM-DD (UTC)
      function formatDate(date){
        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const day = String(date.getUTCDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function updateCalendar(){
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        monthLabel.textContent = currentDate.toLocaleString('default',{month:'long'});
        yearSelect.value = year;

        const calendarDays = document.getElementById('calendar-days');
        calendarDays.innerHTML = '';

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month+1,0).getDate();

        for(let i=0;i<firstDay;i++){
          const e=document.createElement('div');
          e.className="calendar-cell empty";
          calendarDays.appendChild(e);
        }

        for(let d=1; d<=daysInMonth; d++){
          const cellDate = new Date(Date.UTC(year, month, d));
          const cell = document.createElement('div');
          cell.className="calendar-cell";
          cell.textContent=d;

          if(cellDate < minDate || cellDate > maxDate){
            cell.classList.add('disabled');
          } else {
            if(selectedDate && formatDate(cellDate) === formatDate(selectedDate)){
              cell.classList.add('selected');
            }
            cell.addEventListener('click',()=>{
              selectedDate = cellDate;
              document.getElementById('selected-date').textContent = formatDate(selectedDate);
              document.getElementById('calendar-popup').style.display='none';
              updateCalendar();
            });
          }
          calendarDays.appendChild(cell);
        }
      }

      updateCalendar();

      document.getElementById('date-display').addEventListener('click',()=>{
        const popup=document.getElementById('calendar-popup');
        popup.style.display=popup.style.display==='block'?'none':'block';
      });

      document.getElementById('prev-month').addEventListener('click',()=>{
        currentDate.setMonth(currentDate.getMonth()-1);
        if(currentDate<minDate) currentDate=new Date(minDate);
        updateCalendar();
      });

      document.getElementById('next-month').addEventListener('click',()=>{
        currentDate.setMonth(currentDate.getMonth()+1);
        if(currentDate>maxDate) currentDate=new Date(maxDate);
        updateCalendar();
      });

      yearSelect.addEventListener('change',()=>{
        currentDate.setFullYear(parseInt(yearSelect.value,10));
        if(currentDate<minDate) currentDate=new Date(minDate);
        if(currentDate>maxDate) currentDate=new Date(maxDate);
        updateCalendar();
      });

      document.addEventListener('click',e=>{
        const cal=document.getElementById('calendar-popup');
        const disp=document.getElementById('date-display');
        if(!cal.contains(e.target)&&!disp.contains(e.target)){
          cal.style.display='none';
        }
      });

      async function fetchCurrentPrice() {
        try {
          const response = await fetch('https://price.hns.dev/latest');
          if (!response.ok) throw new Error('Failed to fetch current price');
          
          // The API returns a simple number, not a JSON object
          const price = await response.text();
          document.getElementById('current-price-value').textContent = `$${parseFloat(price).toFixed(6)}`;
        } catch(error) {
          console.error('Error fetching current price:', error);
          document.getElementById('current-price-value').textContent = 'Unavailable';
          
          // Fallback: Try with CORS proxy if direct request fails
          try {
            const proxyResponse = await fetch('https://corsproxy.io/?' + encodeURIComponent('https://price.hns.dev/latest'));
            if (proxyResponse.ok) {
              const proxyPrice = await proxyResponse.text();
              document.getElementById('current-price-value').textContent = `$${parseFloat(proxyPrice).toFixed(6)}`;
            }
          } catch(proxyError) {
            console.error('CORS proxy also failed:', proxyError);
          }
        }
      }

      fetchCurrentPrice();

      document.getElementById('calculate-btn').addEventListener('click',()=>{
        if(!selectedDate) return showError('Please select a date');
        const amt=parseFloat(document.getElementById('amount').value);
        if(!amt||amt<=0) return showError('Please enter a valid HNS amount');
        if(amt>888000000) return showError('Maximum HNS is 888,000,000');
        document.getElementById('error').style.display='none';
        document.getElementById('result').style.display='none';
        document.getElementById('loading').style.display='block';
        fetchHistoricalData(formatDate(selectedDate),amt);
      });
    });

    function showError(msg){
      const e=document.getElementById('error');
      e.textContent=msg; e.style.display='block';
    }

    // High precision calculation function
    function calculatePreciseAverage(data) {
      // Convert prices to integers (multiply by 1e12 for BTC to preserve precision)
      const multiplier = 1e12;
      const sum = data.reduce((total, item) => {
        return total + Math.round(item.price * multiplier);
      }, 0);
      
      // Calculate average and convert back to decimal
      return sum / data.length / multiplier;
    }

    // Function to format very small numbers without scientific notation
    function formatSmallNumber(num, precision = 12) {
      if (num >= 0.001) {
        return num.toFixed(precision);
      }
      
      // For very small numbers, convert to string and pad with zeros
      const numStr = num.toFixed(precision);
      if (numStr.includes('e')) {
        // Handle scientific notation
        const [coefficient, exponent] = numStr.split('e');
        const exp = parseInt(exponent);
        const decimalPlaces = Math.abs(exp) - 1;
        return '0.' + '0'.repeat(decimalPlaces) + coefficient.replace('.', '').replace('-', '');
      }
      return numStr;
    }

    async function fetchHistoricalData(date, amt){
      try {
        // Fetch USD and BTC prices in parallel
        const [usdResp, btcResp] = await Promise.all([
          fetch(`https://corsproxy.io/?${encodeURIComponent(`https://price.hns.dev/historical?from=${date}&currency=usd`)}`),
          fetch(`https://corsproxy.io/?${encodeURIComponent(`https://price.hns.dev/historical?from=${date}&currency=btc`)}`)
        ]);

        if(!usdResp.ok || !btcResp.ok) throw new Error();

        const usdData = await usdResp.json();
        const btcData = await btcResp.json();

        if(!usdData.length || !btcData.length) throw new Error("No data");

        // Use high precision calculation
        const avgUsd = calculatePreciseAverage(usdData);
        const avgBtc = calculatePreciseAverage(btcData);

        // Calculate values with high precision
        const valUsd = Math.round(avgUsd * amt * 1e6) / 1e6;
        
        // Special handling for BTC to avoid floating point issues with very small numbers
        const valBtc = avgBtc * amt;
        
        // Format BTC value with proper precision (decimal notation, not scientific)
        const btcFormatted = formatSmallNumber(valBtc, 12);

        // Update DOM
        document.getElementById('price').textContent = 
          `$${valUsd.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:6})}`;
        document.getElementById('price-btc').textContent = 
          `${btcFormatted} BTC`;

        document.getElementById('date-info').textContent = 
          `Based on avg price $${avgUsd.toFixed(6)} / ${formatSmallNumber(avgBtc, 12)} BTC per HNS on ${date}`;

        document.getElementById('loading').style.display='none';
        document.getElementById('result').style.display='block';
        
        // Log for debugging
        console.log('Precise average calculation:', {
          date: date,
          usdDataPoints: usdData.length,
          btcDataPoints: btcData.length,
          avgUsd: avgUsd,
          avgBtc: avgBtc,
          calculatedValueUSD: valUsd,
          calculatedValueBTC: valBtc,
          formattedBTC: btcFormatted
        });
      } catch(err) {
        console.error(err);
        document.getElementById('loading').style.display='none';
        showError('Error fetching data, try another date.');
      }
    }
  </script>
</body>
</html>
